<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3X3 CCD ì „í•˜ ì „ì†¡ ë©”ì»¤ë‹ˆì¦˜</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg-color: #f8fafc;
            --panel-bg: #ffffff;
            --text-main: #334155;
            --border-color: #e2e8f0;
            --elec-on: #dc2626; /* ì „ì•• ì¸ê°€(+V) */
            --elec-off: #64748b; /* ì „ì•• ë¯¸ì¸ê°€(0V) */
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--panel-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 1.6rem; color: #0f172a; margin: 0 0 8px 0; }
        .desc { font-size: 0.95rem; color: #64748b; margin: 0; }

        .view-section {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            background: #fdfdfd;
        }

        .view-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        canvas {
            display: block;
            width: 100%;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .btn-secondary { background: #e2e8f0; color: #475569; }
        .btn-secondary:hover { background: #cbd5e1; }

        /* ì„¤ëª… íŒ¨ë„ */
        .explanation-box {
            background: #eff6ff;
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 6px;
            min-height: 70px;
        }
        .step-title { font-weight: bold; color: #1e40af; margin-bottom: 8px; font-size: 1.05rem; }
        .step-desc { font-size: 0.95rem; line-height: 1.5; margin: 0; color: #334155; }

        /* ì¶œë ¥ ë°ì´í„° íŒ¨ë„ */
        .output-panel {
            margin-top: 15px;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .output-panel h3 { margin: 0 0 10px 0; font-size: 1.05rem; color: #0f172a; }
        .data-array { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
            min-height: 40px; 
        }
        .data-cell {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            background: white; border: 1px solid var(--border-color); border-radius: 6px; font-weight: bold; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>3X3 CCD ì „í•˜ ì „ì†¡ ë™ê¸°í™” ì‹œë®¬ë ˆì´ì…˜</h1>
        <p class="desc">í™”ì†Œ ë‚´ë¶€ì˜ 3ìƒ ì „ê·¹(E1, E2, E3) ì „ì•• ì œì–´ê°€ í”½ì…€ ê°„ì˜ ì „í•˜ ì´ë™ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.</p>
    </header>

    <div class="view-section">
        <div class="view-title">ğŸ” ê±°ì‹œì  ê´€ì : 3X3 í™”ì†Œ ë°°ì—´ ì „ì²´ ì „ì†¡ íë¦„</div>
        <canvas id="macroCanvas" width="850" height="420"></canvas>
    </div>

    <div class="view-section">
        <div class="view-title">ğŸ”¬ ë¯¸ì‹œì  ê´€ì : ë¹¨ê°„ ì ì„  í™•ëŒ€ ì˜ì—­ì˜ ë‹¨ë©´ë„ (2ê°œ í™”ì†Œ ì „ì²´ êµ¬ì¡°)</div>
        <canvas id="microCanvas" width="850" height="230"></canvas>
    </div>
    
    <div class="controls">
        <button id="btnInit" class="btn-secondary">ì´ˆê¸°í™”</button>
        <button id="btnExpose" class="btn-primary">1. ë¹› ë¹„ì¶”ê¸° (ì „í•˜ ìƒì„±)</button>
        <button id="btnNext" class="btn-primary" disabled>ì „í•˜ 1ì¹¸ ì´ë™ (Clock Cycle)</button>
    </div>

    <div class="explanation-box">
        <div class="step-title" id="stepTitle">ëŒ€ê¸° ìƒíƒœ</div>
        <p class="step-desc" id="stepDesc">'ë¹› ë¹„ì¶”ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ê° í™”ì†Œì— ì…ì‚¬ê´‘ì— ì˜í•œ ì „í•˜(ì „ì)ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.</p>
    </div>

    <div class="output-panel">
        <h3>ì¶œë ¥ëœ ì§ë ¬ ë””ì§€í„¸ ì‹ í˜¸ (ì¦í­ê¸° íŒë… ê²°ê³¼)</h3>
        <div class="data-array" id="outputData"></div>
    </div>
</div>

<script>
    // --- ê³µí†µ ìƒíƒœ ë³€ìˆ˜ ---
    let stepCount = 0;
    let isAnimating = false;
    let animProgress = 0; 
    let animStartTime = 0;
    const ANIM_DURATION = 2000; // ì´ë™ ê³¼ì •ì„ ìì„¸íˆ ë³´ê¸° ìœ„í•´ 2ì´ˆ

    let outputValues = [];
    let charges = [];
    
    // ë¯¸ì‹œì  ë·° ë™ê¸°í™”ìš© í•˜ì´ë¼ì´íŠ¸ ìœ„ì¹˜ ë° ì „í•˜ ê°ì²´ ë³€ìˆ˜
    let hlStart = null; 
    let hlEnd = null;
    let microChargeEntering = null;
    let microChargeP1 = null;
    let microChargeP2 = null;

    // --- ê±°ì‹œì  ê´€ì (Macro) ìº”ë²„ìŠ¤ ---
    const macCanvas = document.getElementById('macroCanvas');
    const macCtx = macCanvas.getContext('2d');
    
    const CELL_SIZE = 65;
    const SPACING = 10;
    const START_X = 180;
    const START_Y = 25;
    
    // 3x3 í™”ì†Œ, ìˆ˜í‰ ë ˆì§€ìŠ¤í„°, ì¦í­ê¸°, íŒë…(ì†Œë©¸) ìœ„ì¹˜ì˜ ì ˆëŒ€ ì¢Œí‘œ
    const POS = {
        P11: {x: START_X, y: START_Y},
        P12: {x: START_X + CELL_SIZE + SPACING, y: START_Y},
        P13: {x: START_X + 2*(CELL_SIZE + SPACING), y: START_Y},
        P21: {x: START_X, y: START_Y + CELL_SIZE + SPACING},
        P22: {x: START_X + CELL_SIZE + SPACING, y: START_Y + CELL_SIZE + SPACING},
        P23: {x: START_X + 2*(CELL_SIZE + SPACING), y: START_Y + CELL_SIZE + SPACING},
        P31: {x: START_X, y: START_Y + 2*(CELL_SIZE + SPACING)},
        P32: {x: START_X + CELL_SIZE + SPACING, y: START_Y + 2*(CELL_SIZE + SPACING)},
        P33: {x: START_X + 2*(CELL_SIZE + SPACING), y: START_Y + 2*(CELL_SIZE + SPACING)},
        H1:  {x: START_X, y: START_Y + 3*(CELL_SIZE + SPACING) + 20},
        H2:  {x: START_X + CELL_SIZE + SPACING, y: START_Y + 3*(CELL_SIZE + SPACING) + 20},
        H3:  {x: START_X + 2*(CELL_SIZE + SPACING), y: START_Y + 3*(CELL_SIZE + SPACING) + 20},
        AMP: {x: START_X + 3*(CELL_SIZE + SPACING), y: START_Y + 3*(CELL_SIZE + SPACING) + 20},
        READ:{x: START_X + 4*(CELL_SIZE + SPACING), y: START_Y + 3*(CELL_SIZE + SPACING) + 20}
    };

    // --- ë¯¸ì‹œì  ê´€ì (Micro) ìº”ë²„ìŠ¤ ---
    const micCanvas = document.getElementById('microCanvas');
    const micCtx = micCanvas.getContext('2d');

    const btnInit = document.getElementById('btnInit');
    const btnExpose = document.getElementById('btnExpose');
    const btnNext = document.getElementById('btnNext');
    const stepTitle = document.getElementById('stepTitle');
    const stepDesc = document.getElementById('stepDesc');
    const outputData = document.getElementById('outputData');

    function getChargeColor(value, alpha=1) {
        const a = 0.4 + (value / 100) * 0.6;
        return `rgba(37, 99, 235, ${a * alpha})`;
    }

    // ê±°ì‹œì  í™”ë©´ì˜ ë¹¨ê°„ìƒ‰ í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤ ê·¸ë¦¬ê¸°
    function drawHighlightBox(startKey, endKey) {
        if (!POS[startKey] || !POS[endKey] || endKey === 'READ') return;
        const p1 = POS[startKey];
        const p2 = POS[endKey];
        const minX = Math.min(p1.x, p2.x) - 5;
        const minY = Math.min(p1.y, p2.y) - 5;
        const maxX = Math.max(p1.x, p2.x) + CELL_SIZE + 5;
        const maxY = Math.max(p1.y, p2.y) + CELL_SIZE + 5;
        
        macCtx.strokeStyle = "rgba(220, 38, 38, 0.9)";
        macCtx.setLineDash([6, 6]);
        macCtx.lineWidth = 2.5;
        macCtx.strokeRect(minX, minY, maxX - minX, maxY - minY);
        macCtx.setLineDash([]);
        
        macCtx.fillStyle = "rgba(220, 38, 38, 0.9)";
        macCtx.font = "bold 12px sans-serif";
        macCtx.fillText("ğŸ”´ ì•„ë˜ ë¯¸ì‹œì  ë·° ì˜ì—­ (2ê°œ í™”ì†Œ)", minX + (maxX - minX)/2, maxY + 15);
    }

    // ==========================================
    // ê·¸ë¦¬ê¸°: ê±°ì‹œì  ê´€ì  (Macro)
    // ==========================================
    function drawMacro() {
        macCtx.clearRect(0, 0, macCanvas.width, macCanvas.height);
        macCtx.textAlign = 'center'; macCtx.textBaseline = 'middle';

        // 1. í”½ì…€ ë° ë ˆì§€ìŠ¤í„° ê·¸ë¦¬ê¸° (ë‚´ë¶€ 3ìƒ ì „ê·¹ì„  í¬í•¨)
        const drawCell = (key, label, isHReg=false) => {
            const p = POS[key];
            macCtx.fillStyle = isHReg ? '#e2e8f0' : '#f1f5f9';
            macCtx.strokeStyle = isHReg ? '#94a3b8' : '#cbd5e1';
            macCtx.lineWidth = 2;
            macCtx.fillRect(p.x, p.y, CELL_SIZE, CELL_SIZE);
            macCtx.strokeRect(p.x, p.y, CELL_SIZE, CELL_SIZE);
            
            macCtx.strokeStyle = 'rgba(148, 163, 184, 0.4)';
            macCtx.lineWidth = 1;
            macCtx.beginPath();
            macCtx.fillStyle = 'rgba(100, 116, 139, 0.8)';
            macCtx.font = 'bold 10px sans-serif';
            
            if (isHReg) {
                const step = CELL_SIZE / 3;
                macCtx.moveTo(p.x + step, p.y); macCtx.lineTo(p.x + step, p.y + CELL_SIZE);
                macCtx.moveTo(p.x + step*2, p.y); macCtx.lineTo(p.x + step*2, p.y + CELL_SIZE);
                macCtx.stroke();
                macCtx.fillText('E1', p.x + step*0.5, p.y + 10);
                macCtx.fillText('E2', p.x + step*1.5, p.y + 10);
                macCtx.fillText('E3', p.x + step*2.5, p.y + 10);
            } else {
                const step = CELL_SIZE / 3;
                macCtx.moveTo(p.x, p.y + step); macCtx.lineTo(p.x + CELL_SIZE, p.y + step);
                macCtx.moveTo(p.x, p.y + step*2); macCtx.lineTo(p.x + CELL_SIZE, p.y + step*2);
                macCtx.stroke();
                macCtx.fillText('E1', p.x + 10, p.y + step*0.5 + 2);
                macCtx.fillText('E2', p.x + 10, p.y + step*1.5 + 2);
                macCtx.fillText('E3', p.x + 10, p.y + step*2.5 + 2);
            }

            macCtx.fillStyle = '#1e293b';
            macCtx.font = 'bold 12px sans-serif';
            macCtx.fillText(label, p.x + CELL_SIZE/2, p.y + CELL_SIZE/2 + 15);
        };

        drawCell('P11', 'P11'); drawCell('P12', 'P12'); drawCell('P13', 'P13');
        drawCell('P21', 'P21'); drawCell('P22', 'P22'); drawCell('P23', 'P23');
        drawCell('P31', 'P31'); drawCell('P32', 'P32'); drawCell('P33', 'P33');
        drawCell('H1', 'H1', true); drawCell('H2', 'H2', true); drawCell('H3', 'H3', true);

        // ì¦í­ê¸°
        const pA = POS.AMP;
        macCtx.fillStyle = '#fef08a'; macCtx.strokeStyle = '#eab308';
        macCtx.beginPath();
        macCtx.moveTo(pA.x, pA.y); macCtx.lineTo(pA.x + CELL_SIZE, pA.y + CELL_SIZE/2);
        macCtx.lineTo(pA.x, pA.y + CELL_SIZE); macCtx.closePath();
        macCtx.fill(); macCtx.stroke();
        macCtx.fillStyle = '#854d0e'; macCtx.font = 'bold 12px sans-serif';
        macCtx.fillText("ì¦í­ê¸°", pA.x + CELL_SIZE/3, pA.y + CELL_SIZE/2);

        // ë°©í–¥ ê°€ì´ë“œ í…ìŠ¤íŠ¸
        macCtx.fillStyle = '#94a3b8'; macCtx.font = '14px sans-serif';
        macCtx.fillText("â†“ ìˆ˜ì§ ì „ì†¡ ë°©í–¥", 100, 150);
        macCtx.fillText("ìˆ˜í‰ ì „ì†¡ ë°©í–¥ â†’", 300, 360);

        // í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤ (ë™ê¸°í™”)
        if (hlStart && hlEnd) {
            drawHighlightBox(hlStart, hlEnd);
        }

        // 2. ì „í•˜ ê·¸ë¦¬ê¸°
        charges.forEach(c => {
            if (c.currPosKey === 'READ' && !isAnimating) return; 
            
            let cx, cy, alpha = 1.0;
            if (isAnimating && c.nextPosKey && c.nextPosKey !== c.currPosKey) {
                const start = POS[c.currPosKey];
                const end = POS[c.nextPosKey];
                const ease = animProgress < 0.5 ? 2 * animProgress * animProgress : 1 - Math.pow(-2 * animProgress + 2, 2) / 2;
                cx = start.x + (end.x - start.x) * ease + CELL_SIZE/2;
                cy = start.y + (end.y - start.y) * ease + CELL_SIZE/2 - 5;
                
                if (c.nextPosKey === 'READ') alpha = 1 - ease;
            } else {
                cx = POS[c.currPosKey].x + CELL_SIZE/2;
                cy = POS[c.currPosKey].y + CELL_SIZE/2 - 5; 
                if (c.currPosKey === 'READ') alpha = 0;
            }

            if (alpha > 0) {
                macCtx.globalAlpha = alpha;
                macCtx.fillStyle = getChargeColor(c.val);
                macCtx.beginPath(); macCtx.arc(cx, cy, 18, 0, Math.PI * 2); macCtx.fill();
                macCtx.fillStyle = '#ffffff'; macCtx.font = 'bold 14px sans-serif';
                macCtx.fillText(c.id, cx, cy);
                macCtx.globalAlpha = 1.0;
            }
        });
    }

    // ==========================================
    // ê·¸ë¦¬ê¸°: ë¯¸ì‹œì  ê´€ì  (Micro) - 6ê°œ ì „ê·¹ (í™”ì†Œ 2ê°œ)
    // ==========================================
    function getEx(i) {
        return 90 + i * 110; 
    }

    function getArea(s, p) {
        const ew = 100;
        if (p < 0.16) return [getEx(s), getEx(s) + ew];
        if (p < 0.33) return [getEx(s), getEx(s+1) + ew];
        if (p < 0.50) return [getEx(s+1), getEx(s+1) + ew];
        if (p < 0.66) return [getEx(s+1), getEx(s+2) + ew];
        if (p < 0.83) return [getEx(s+2), getEx(s+2) + ew];
        return [getEx(s+2), getEx(s+3) + ew];
    }

    function drawMicro() {
        micCtx.clearRect(0, 0, micCanvas.width, micCanvas.height);
        
        // ë°˜ë„ì²´ êµ¬ì¡°ë¬¼ (í”½ì…€ 2ê°œë¥¼ í¬í•¨í•˜ëŠ” ë„“ì€ ì±„ë„)
        micCtx.fillStyle = "#94a3b8"; micCtx.fillRect(20, 140, 810, 40); 
        micCtx.fillStyle = "#fcd34d"; micCtx.fillRect(20, 90, 810, 50);  
        micCtx.fillStyle = "#5eead4"; micCtx.fillRect(20, 70, 810, 20);  

        micCtx.fillStyle = "#ffffff"; micCtx.font = "12px sans-serif";
        micCtx.textAlign = "left";
        micCtx.fillText("ní˜• ë°˜ë„ì²´", 30, 120);

        // 3ìƒ í´ëŸ­ ë§¤í•‘ (ì§„í–‰ë¥  pì— ë”°ë¥¸ ì „ì•• ë³€í™” - 6ê°œ ì „ê·¹)
        const p = isAnimating ? animProgress : 0;
        let vState = [1,0,0, 1,0,0]; // í™”ì†Œ 1(E1,E2,E3), í™”ì†Œ 2(E1,E2,E3)

        if (p < 0.16) vState = [1,0,0, 1,0,0];
        else if (p < 0.33) vState = [1,1,0, 1,1,0];
        else if (p < 0.50) vState = [0,1,0, 0,1,0];
        else if (p < 0.66) vState = [0,1,1, 0,1,1];
        else if (p < 0.83) vState = [0,0,1, 0,0,1];
        else vState = [1,0,1, 1,0,1]; // ì „ìê°€ ë‹¤ìŒ í™”ì†Œì˜ E1ìœ¼ë¡œ ë„˜ì–´ê°
        
        if (!isAnimating && stepCount > 0) { 
            vState = [1,0,0, 1,0,0]; 
        } 

        // ì „ê·¹ ê·¸ë¦¬ê¸° (ì´ 6ê°œ)
        const ew = 100, eh = 25, ey = 45;
        const labels = ["E1", "E2", "E3", "E1", "E2", "E3"];

        for (let i = 0; i < 6; i++) {
            const isV = vState[i] === 1;
            micCtx.fillStyle = isV ? "#dc2626" : "#64748b";
            micCtx.fillRect(getEx(i), ey, ew, eh);
            
            micCtx.strokeStyle = "#334155"; micCtx.lineWidth = 1.5;
            micCtx.beginPath(); micCtx.moveTo(getEx(i)+ew/2, ey); micCtx.lineTo(getEx(i)+ew/2, ey-15); micCtx.stroke();
            
            micCtx.fillStyle = isV ? "#dc2626" : "#64748b";
            micCtx.font = "bold 13px sans-serif";
            micCtx.textAlign = "center";
            micCtx.fillText(isV ? "+V ì¸ê°€" : "0V", getEx(i)+ew/2, ey-20);
            
            micCtx.fillStyle = "#ffffff"; micCtx.font = "bold 12px sans-serif";
            micCtx.fillText(labels[i], getEx(i)+ew/2, ey+17);
        }

        // í”½ì…€(í™”ì†Œ) ë‹¨ìœ„ ì¹˜ìˆ˜ì„  ë° ë ˆì´ë¸” ë™ê¸°í™” í‘œì‹œ
        const label1 = hlStart || "í™”ì†Œ 1";
        const label2 = hlEnd ? (hlEnd === 'READ' ? "ì¶œë ¥ë‹¨(ì†Œë©¸)" : hlEnd) : "í™”ì†Œ 2";

        // í™”ì†Œ ê²½ê³„ì„  (x = 85, 415, 745)
        micCtx.strokeStyle = "rgba(220, 38, 38, 0.7)";
        micCtx.setLineDash([4, 4]);
        micCtx.lineWidth = 2;
        micCtx.beginPath();
        micCtx.moveTo(85, 25); micCtx.lineTo(85, 190); 
        micCtx.moveTo(415, 25); micCtx.lineTo(415, 190); 
        micCtx.moveTo(745, 25); micCtx.lineTo(745, 190); 
        micCtx.stroke();
        micCtx.setLineDash([]);

        micCtx.fillStyle = "#dc2626"; micCtx.font = "bold 14px sans-serif";
        micCtx.textAlign = "center";
        micCtx.fillText(`[ ${label1} ] ì˜ì—­`, 250, 210);
        micCtx.fillText(`[ ${label2} ] ì˜ì—­`, 580, 210);

        // ì „ì ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì „ìœ„ ìš°ë¬¼ ìœ„ì¹˜ì— ë§ê²Œ ë Œë”ë§)
        function drawElectrons(area, charge) {
            if (!charge) return;
            const eCount = 12;
            const step = (area[1] - area[0] - 20) / Math.max(1, eCount - 1);
            
            micCtx.fillStyle = getChargeColor(charge.val, 1.0);
            micCtx.strokeStyle = "#1e3a8a";
            micCtx.lineWidth = 1;

            for(let i=0; i<eCount; i++) {
                const x = area[0] + 10 + step * i;
                // ë°˜ë„ì²´ ì±„ë„ ì˜ì—­ ë‚´ë¶€ì— ìˆì„ ë•Œë§Œ ë Œë”ë§
                if (x > 20 && x < 830) {
                    const y = 115 + (i%2 === 0 ? 5 : 15); 
                    micCtx.beginPath(); micCtx.arc(x, y, 6, 0, Math.PI * 2);
                    micCtx.fill(); micCtx.stroke();
                    
                    micCtx.fillStyle = "#ffffff";
                    micCtx.font = "bold 10px sans-serif";
                    micCtx.textAlign="center"; micCtx.textBaseline="middle";
                    micCtx.fillText(charge.id, x, y);
                    micCtx.fillStyle = getChargeColor(charge.val, 1.0);
                }
            }
        }

        // ë™ê¸°í™”ëœ ì „í•˜ ì´ë™ ë Œë”ë§
        if (stepCount > 0) {
            // ì™¸ë¶€ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ì „í•˜, í™”ì†Œ1ì—ì„œ ì¶œë°œí•˜ëŠ” ì „í•˜, í™”ì†Œ2ì—ì„œ ì¶œë°œí•˜ëŠ” ì „í•˜ë¥¼ ëª¨ë‘ ê·¸ë¦¼
            if (microChargeEntering) drawElectrons(getArea(-3, p), microChargeEntering);
            if (microChargeP1) drawElectrons(getArea(0, p), microChargeP1);
            if (microChargeP2) drawElectrons(getArea(3, p), microChargeP2);
        }
    }

    // ==========================================
    // ìƒíƒœ ì œì–´ ë° ì• ë‹ˆë©”ì´ì…˜ ë¡œì§
    // ==========================================
    function updateUI() {
        outputData.innerHTML = '';
        outputValues.forEach(val => {
            const div = document.createElement('div');
            div.className = 'data-cell'; div.textContent = val.id;
            div.style.backgroundColor = getChargeColor(val.val, 1);
            outputData.appendChild(div);
        });
    }

    function resetSim() {
        stepCount = 0; isAnimating = false; charges = []; outputValues = [];
        hlStart = null; hlEnd = null;
        microChargeEntering = null; microChargeP1 = null; microChargeP2 = null;
        btnExpose.disabled = false; btnNext.disabled = true; btnNext.textContent = "ì „í•˜ 1ì¹¸ ì´ë™ (Clock Cycle)";
        stepTitle.textContent = "ëŒ€ê¸° ìƒíƒœ"; 
        stepDesc.textContent = "'ë¹› ë¹„ì¶”ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì…ì‚¬ê´‘ì— ì˜í•œ ì „í•˜(ì „ì)ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.";
        drawMacro(); drawMicro(); updateUI();
    }

    function expose() {
        charges = [
            { id: 'A', val: Math.floor(Math.random()*60)+40, currPosKey: 'P11', nextPosKey: 'P11' },
            { id: 'B', val: Math.floor(Math.random()*60)+40, currPosKey: 'P12', nextPosKey: 'P12' },
            { id: 'C', val: Math.floor(Math.random()*60)+40, currPosKey: 'P13', nextPosKey: 'P13' },
            { id: 'D', val: Math.floor(Math.random()*60)+40, currPosKey: 'P21', nextPosKey: 'P21' },
            { id: 'E', val: Math.floor(Math.random()*60)+40, currPosKey: 'P22', nextPosKey: 'P22' },
            { id: 'F', val: Math.floor(Math.random()*60)+40, currPosKey: 'P23', nextPosKey: 'P23' },
            { id: 'G', val: Math.floor(Math.random()*60)+40, currPosKey: 'P31', nextPosKey: 'P31' },
            { id: 'H', val: Math.floor(Math.random()*60)+40, currPosKey: 'P32', nextPosKey: 'P32' },
            { id: 'I', val: Math.floor(Math.random()*60)+40, currPosKey: 'P33', nextPosKey: 'P33' }
        ];
        stepCount = 1; btnExpose.disabled = true; btnNext.disabled = false;
        
        hlStart = 'P21'; hlEnd = 'P31'; // ê¸°ë³¸ í•˜ì´ë¼ì´íŠ¸ ìœ„ì¹˜
        microChargeP1 = charges.find(c => c.currPosKey === 'P21');
        microChargeP2 = charges.find(c => c.currPosKey === 'P31');
        
        stepTitle.textContent = "1ë‹¨ê³„: ì „í•˜ ì¶•ì  (ê´‘ì „ íš¨ê³¼)"; 
        stepDesc.innerHTML = "ë¹›ì€ í™”ì†Œ ì „ì²´ ë©´ì ì— ì…ì‚¬í•˜ì—¬ ê´‘ì „ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br>í•˜ì§€ë§Œ ë…¸ì¶œ(Exposure) ë‹¨ê³„ì—ì„œëŠ” <b>E1 ì „ê·¹ì—ë§Œ +V ì „ì••</b>ì„ ì¸ê°€í•˜ì—¬ 'ì „ìœ„ ìš°ë¬¼'ì„ í˜•ì„±í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í™”ì†Œ ë‚´ ì–´ë””ì„œ ìƒì„±ëœ ì „ìë“  ì „ê¸°ì¥ì— ì˜í•´ ì¦‰ì‹œ E1 ì•„ë˜ë¡œ ëŒë ¤ê°€ ëª¨ì´ê²Œ ë©ë‹ˆë‹¤.";
        drawMacro(); drawMicro();
    }

    function setNextTargets() {
        let hHasCharge = charges.some(c => (c.currPosKey.startsWith('H') || c.currPosKey === 'AMP') && c.currPosKey !== 'READ');
        let pHasCharge = charges.some(c => c.currPosKey.startsWith('P'));

        let isVShift = false;

        if (hHasCharge) {
            charges.forEach(c => {
                if (c.currPosKey === 'H1') c.nextPosKey = 'H2';
                if (c.currPosKey === 'H2') c.nextPosKey = 'H3';
                if (c.currPosKey === 'H3') c.nextPosKey = 'AMP';
                if (c.currPosKey === 'AMP') c.nextPosKey = 'READ';
            });
            isVShift = false;
        } else if (pHasCharge) {
            charges.forEach(c => {
                if (c.currPosKey === 'P11') c.nextPosKey = 'P21';
                if (c.currPosKey === 'P12') c.nextPosKey = 'P22';
                if (c.currPosKey === 'P13') c.nextPosKey = 'P23';
                if (c.currPosKey === 'P21') c.nextPosKey = 'P31';
                if (c.currPosKey === 'P22') c.nextPosKey = 'P32';
                if (c.currPosKey === 'P23') c.nextPosKey = 'P33';
                if (c.currPosKey === 'P31') c.nextPosKey = 'H1';
                if (c.currPosKey === 'P32') c.nextPosKey = 'H2';
                if (c.currPosKey === 'P33') c.nextPosKey = 'H3';
            });
            isVShift = true;
        } else {
            btnNext.disabled = true;
            btnNext.textContent = "ì „ì†¡ ì™„ë£Œ";
            stepTitle.textContent = "ëª¨ë“  ì „í•˜ íŒë… ì™„ë£Œ";
            stepDesc.textContent = "3x3 í™”ì†Œ(9ê°œ)ì˜ 2ì°¨ì› ë³‘ë ¬ ë°ì´í„°ê°€ ë‹¨ì¼ ì¦í­ê¸°ë¥¼ í†µí•´ ì™„ë²½íˆ 1ì°¨ì› ì§ë ¬ ë°ì´í„°ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
            hlStart = null; hlEnd = null;
            microChargeEntering = null; microChargeP1 = null; microChargeP2 = null;
            drawMacro(); drawMicro();
            return false; 
        }

        stepCount++;
        
        // ë™ì ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸ í•  ìŒ ì°¾ê¸° (ì„ì˜ì˜ ê¸°ì¤€ ì´ë™ í”½ì…€ ì„ ì •)
        let activeMove = charges.find(c => c.currPosKey !== c.nextPosKey && c.nextPosKey !== 'READ');
        if (activeMove) {
            hlStart = activeMove.currPosKey;
            hlEnd = activeMove.nextPosKey;
        } else {
            hlStart = 'AMP'; hlEnd = 'READ';
        }

        // ë¯¸ì‹œì  í™”ë©´ ë™ê¸°í™”ë¥¼ ìœ„í•œ ì „í•˜ ê°ì²´ ì°¾ê¸°
        microChargeP1 = charges.find(c => c.currPosKey === hlStart) || null;
        microChargeP2 = charges.find(c => c.currPosKey === hlEnd) || null;
        microChargeEntering = charges.find(c => c.nextPosKey === hlStart && c.currPosKey !== hlStart) || null;

        if (isVShift) {
            stepTitle.textContent = `ì´ë™ ë‹¨ê³„: ìˆ˜ì§ ì „ì†¡ (Vertical Shift)`;
            stepDesc.innerHTML = "í™”ì†Œ ë°°ì—´ì˜ ëª¨ë“  ì „í•˜ê°€ ë™ì‹œì— ì•„ë˜ë¡œ í•œ ì¹¸ ë‚´ë ¤ì˜µë‹ˆë‹¤.<br><b>ë¯¸ì‹œì  ì›ë¦¬ í™•ì¸:</b> ì•„ë˜ìª½ 2ê°œ í™”ì†Œ ë‹¨ë©´ì—ì„œ <b>E1, E2, E3 ì „ê·¹ ì „ì••ì´ ìˆœì°¨ì ìœ¼ë¡œ ë³€í•˜ë©°</b> ì „ì ë­‰ì¹˜ë¥¼ ì„œë¡œ ì„ì´ì§€ ì•Šê²Œ ë‹¤ìŒ í™”ì†Œë¡œ ë°€ì–´ë‚´ëŠ” ê³¼ì •ì„ ê´€ì°°í•˜ì„¸ìš”.";
        } else {
            stepTitle.textContent = `ì´ë™ ë‹¨ê³„: ìˆ˜í‰ ì „ì†¡ ë° ì¦í­ê¸° íŒë…`;
            stepDesc.innerHTML = "ìˆ˜í‰ ë ˆì§€ìŠ¤í„° ë‚´ë¶€ì˜ ì „í•˜ê°€ ìš°ì¸¡ìœ¼ë¡œ í•œ ì¹¸ ì´ë™í•©ë‹ˆë‹¤. ìš°ì¸¡ ë ì¦í­ê¸°(AMP)ì— ë„ë‹¬í•œ ì „í•˜ëŠ” ì „ì•• ì‹ í˜¸ë¡œ ë³€í™˜ë˜ì–´ íŒë…ì„ ë§ˆì¹©ë‹ˆë‹¤.";
        }
        return true;
    }

    function finishStep() {
        charges.forEach(c => {
            c.currPosKey = c.nextPosKey;
            if (c.currPosKey === 'AMP') {
                if (!outputValues.find(o => o.id === c.id)) {
                    outputValues.push({id: c.id, val: c.val});
                }
            }
        });

        // ì´ë™ ì™„ë£Œ í›„ ë¯¸ì‹œì  í™”ë©´ ì •ì§€ ìƒíƒœ ë™ê¸°í™”
        microChargeEntering = null;
        microChargeP1 = charges.find(c => c.currPosKey === hlStart) || null;
        microChargeP2 = charges.find(c => c.currPosKey === hlEnd) || null;

        updateUI();
        drawMacro();
        drawMicro();
        btnNext.disabled = false;
    }

    function animate(timestamp) {
        if (!animStartTime) animStartTime = timestamp;
        animProgress = (timestamp - animStartTime) / ANIM_DURATION;

        if (animProgress >= 1.0) {
            animProgress = 1.0;
            isAnimating = false;
            drawMacro();
            drawMicro();
            finishStep();
        } else {
            drawMacro();
            drawMicro();
            requestAnimationFrame(animate);
        }
    }

    function stepNext() {
        btnNext.disabled = true;
        const willMove = setNextTargets();
        if (willMove) {
            isAnimating = true;
            animStartTime = 0;
            requestAnimationFrame(animate);
        }
    }

    btnInit.addEventListener('click', resetSim);
    btnExpose.addEventListener('click', expose);
    btnNext.addEventListener('click', stepNext);

    drawMacro();
    drawMicro();

</script>

</body>
</html>